✅ 網頁進入流程




1. 國家站點判斷與重定向
* **目的：** 根據使用者的 IP 位址判斷其所在國家，並依據網站配置，決定是否將其自動重定向到對應的國家子網域（例如 tw.example.com），或僅將國家資訊提供給前端介面使用。
* 網址結構：採用子網域 (Subdomain) 結構來區分不同國家站點(非語系，一個國家站點會有多個語系)。
* **核心資訊來源：**
  * **使用者 IP 地址：** 國家代碼：優先透過 CDN 邊緣運算平台（如 Vercel, Cloudflare）在 HTTP 請求頭中提供的地理位置資訊（x-vercel-ip-country）獲取。若此標頭不存在，則啟用備用方案，透過伺服器端的 IP 地理定位服務（如 MaxMind GeoLite2）將 IP 轉換為國家代碼。
  * **預先配置的「國家-子網域映射表」：** 一份預先配置的靜態設定，定義國家代碼與子網域的對應關係。例如：{ "TW": "tw", "US": "us", "JP": "jp" }。
  * **功能啟用開關：** 
    * enableGeoRedirect: (布林值) 是否啟用地理位置判斷功能。 
    * forceRedirect: (布林值) 在 enableGeoRedirect 為 true 的前提下，是否強制將使用者重定向到對應的國家站點。
* **判斷與處理邏輯：**
  * 啟用判斷： 首先檢查 enableGeoRedirect(地理位置) 是否為 true。若為 false，則完全跳過此步驟的後續邏輯。
  * 獲取國家代碼：
    * 獲取使用者的國家代碼 DetectedCountry（例如 "TW"）。
    * 查詢映射表，找到 DetectedCountry 對應的目標子網域 TargetSubdomain（例如 "tw"）。
    * 從當前請求的網址中，解析出當前的子網域 CurrentSubdomain（例如 "us"）。
  * 重定向決策
    * 如果 forceRedirect(重定向) 為 true 且 CurrentSubdomain(使用者的國家代碼) 與 TargetSubdomain(子網域) 不符，伺服器將執行 302 臨時重定向，將使用者導向到正確的子網域，並保持原有的路徑和查詢參數。例如，從 https://us.example.com/path 重定向到 https://tw.example.com/path。
    * 在其他所有情況下（forceRedirect(重定向) 為 false，或使用者已在正確的子網域），不執行任何重定向。DetectedCountry(國家代碼) 資訊將被傳遞到後續步驟使用。

2. 語系資料獲取 API
* **目的：** 此 API 的功能是提供網站所有可用的語系清單，以及一個基於使用者情境的推薦預設語系。它是一個能力提供者，在需要時被呼叫。
* **執行條件：** 僅在「多語系網站」模式下 (enableMultiLanguage 為 true) 才可能被呼叫。
* API： /api/ssr/languages?project=minmax2025&language=[預設語系]
  * project: 專案代碼 (例如 "minmax2025")
  * language: 一個預設語系，用於 API 回傳時的參考。
      * 語系判斷優先順序：
        1. 瀏覽器語言偏好 (Accept-Language header)
        2. 地理位置推薦語系 (基於步驟 1 的 DetectedCountry)
        3. 系統全域預設語系 (例如 "zh-TW")
* 回傳資料：
    * availableLanguages: 可用語系清單 (例如 [{code: "zh-TW", name: "繁體中文"}, ...])
    * defaultLanguage: API 推薦的預設語系
    * version: 語系列表的版本號，用於快取控制


3. Cookie 檢查與語系設定
* **目的 ：** 管理語系相關的 Cookie，並在必要時觸發 API 呼叫以獲取最新的語系資料，實現高效能快取。
* **執行條件：** 僅在「多語系網站」模式下 (enableMultiLanguage 為 true) 執行。
* **Cookie 類型：**
  * **語系資料快取Cookie (languageData)：**
    * 儲存API回傳的語系清單和版本號
    * 用於快取控制，避免重複API呼叫
    * 格式：`{availableLanguages: [...], defaultLanguage: "zh-TW", version: "1.0"}`

  * **使用者偏好語系Cookie (userPreferredLanguage)：**
    * 僅在使用者「主動切換」語系時設定
    * 優先級高於API推薦語系
    * 用於無語系前綴URL的導引決策
* 步驟：
  1. **讀取現有Cookie：**
    * 讀取 languageData Cookie(語系資料快取)
    * 讀取 userPreferredLanguage Cookie(使用者偏好語系)

  2. **語系資料快取檢查：**
    * 檢查 languageData Cookie(語系資料快取) 是否存在
    * 檢查其內部儲存的 version 是否與當前系統設定的語系版本相符

  3. **API呼叫決策：**
    * 如果 languageData Cookie(語系資料快取) 不存在或版本已過期，則執行步驟 2 中定義的「語系資料獲取 API」呼叫
    * 將從 API 獲取到的最新語系資料（包含新的版本號）寫入 languageData Cookie(語系資料快取)

  4. **偏好語系準備：**
    * userPreferredLanguage Cookie(使用者偏好語系) 將在後續步驟中用於語系導引決策
    * 此Cookie僅在前端使用者主動切換語系時才會被設定或更新

4. 解析網址語系與 API 參數組裝
* **目的 ：** 確定當前頁面最終要渲染的語系 (FinalLanguage) 和要傳遞給內容 API 的乾淨路徑 (CleanURI)。
* **處理邏輯 ：**
  * **單語系網站**
    * FinalLanguage 直接使用靜態配置的唯一語系。
    * CleanURI 為原始請求路徑
  * **多語系網站**
    * 確定 FinalLanguage (優先順序如下)：
      1. 從 URL 路徑前綴解析出的語系 (例如 /zh-TW/... → zh-TW)。
      2. 若無，則使用步驟 3 中讀取或設定的語系 Cookie。
      3. 若以上皆無，則使用一個全域的預設語系。
    * 確定 CleanURI:
      * 如果 URL 路徑中匹配到了語系前綴，則移除該前綴部分，得到乾淨路徑。
      * 如果沒有匹配到，則保持原始路徑不變。

5. 語系導引決策 (僅多語系網站)
* **目的：** 當使用者訪問無語系前綴的URL時，自動導引到適當的語系URL。
* **執行條件：**
  * enableMultiLanguage(多語系網站) 為 true
  * 當前URL路徑沒有語系前綴 (例如訪問 http://xxx.com 而非 http://xxx.com/en)
* **導引邏輯：**
  1. 確定目標語系 (優先順序)：
    * 使用者偏好語系 Cookie (userPreferredLanguage) - 來自使用者主動切換
    * API推薦的預設語系 (來自步驟2的defaultLanguage)
    * 系統全域預設語系
  2. 執行302重定向到帶語系前綴的URL
    * 例如：http://xxx.com → http://xxx.com/en
    * 保持原有路徑和查詢參數

6. 呼叫內容 API 與錯誤處理
* **目的 ：** 使用前序步驟準備好的參數，獲取頁面所需的主要內容。
* **處理邏輯 ：**
  1. 組裝 API 請求:
     * language = FinalLanguage (來自步驟 4)
     * uri = CleanURI (來自步驟 4)
  2. 呼叫內容 API: GET /api/ssr/page/detail?project=...&language=[語系]&uri=[路徑]
  3. 回傳處理:
     * 若 API 成功回傳資料 → 進入渲染流程。
     * 若 API 回傳無資料或發生錯誤 → 伺服器應回傳 { notFound: true }，觸發前端框架顯示 404 頁面。

7. 前端 UI 建議與資訊傳遞
* **目的 ：** 在伺服器完成渲染後，前端介面根據後端傳遞的元數據，向使用者顯示友善的切換建議。
* **後端需傳遞的元數據**
  伺服器在渲染頁面時，必須將以下資訊注入到前端 JavaScript 環境中：
  * detectedCountry: 偵測到的使用者國家代碼 (來自步驟 1)。 
  * currentCountrySubdomain: 當前子網域 (來自步驟 1)。 
  * finalLanguage: 當前頁面最終渲染的語系 (來自步驟 4)。 
  * preferredLanguage: 使用者的偏好語系，主要來自 Accept-Language Header。
* **前端顯示邏輯**
  * 國家切換建議:
    * 邏輯: 比較 detectedCountry(使用者國家代碼) 對應的子網域與 currentCountrySubdomain。如果不一致，則根據網站類型顯示相應提示：
      * **多站點架構**: 顯示「建議您前往 XX 站點」的提示
      * **單站點架構**: 顯示「偵測到您位於 XX 國家，是否要切換」
    * 用途範例:
      * 電商網站: 切換到對應國家的商品、價格、配送選項
  * 語系切換建議:
    * 條件: 多語系網站。
    * 邏輯: 
      * 比較 finalLanguage(最終渲染的語系) 與 preferredLanguage(使用者的偏好語系)。如果不一致，且 preferredLanguage(使用者的偏好語系) 是網站支援的可用語系之一，則顯示「建議您切換到 XX 語系」的提示。
      * 當使用者主動切換語系時，設定 userPreferredLanguage Cookie(使用者偏好語系)
      * 導引到新語系的對應頁面URL
