# 網頁進入流程說明

## 重點說明

### 核心設計理念
- **使用者體驗優先**：系統會自動偵測使用者的地理位置和語言偏好，提供最適合的網站版本，減少手動選擇的負擔
- **彈性配置**：透過功能開關 (enableGeoRedirect, forceRedirect, enableMultiLanguage) 可靈活控制各項功能的啟用狀態
- **效能優化**：採用 Cookie 快取機制避免重複 API 呼叫，並優先使用 CDN 邊緣運算提供的地理資訊

### 架構特色
- **多站點 vs 多語系分離**：國家站點 (子網域) 與語系 (URL 前綴) 是獨立的兩個維度，一個國家站點可支援多種語系
- **優雅降級**：當某項功能關閉或資料不可用時，系統會自動退回到預設行為，確保網站正常運作
- **使用者偏好記憶**：系統會記住使用者的主動選擇，並在後續訪問中優先採用

### 決策優先順序
1. **地理重定向**：DetectedCountry → 國家站點映射 → 子網域重定向
2. **語系選擇**：使用者偏好 Cookie > 瀏覽器語言 > 地理推薦 > 系統預設
3. **錯誤處理**：API 失敗或無資料時回傳 404，確保使用者體驗一致性

### 前端整合要點
- 後端需將關鍵元數據 (detectedCountry, finalLanguage 等) 注入前端環境
- 前端根據元數據智慧顯示國家/語系切換建議
- 使用者主動切換時更新相應的 Cookie 設定



## 步驟
###  1. 國家站點判斷與重定向
* **目的：** 根據使用者的 IP 位址判斷其所在國家，並依據網站配置，決定是否將其自動重定向到對應的國家子網域（例如 tw.example.com），或僅將國家資訊提供給前端介面使用。
* 網址結構：採用子網域 (Subdomain) 結構來區分不同國家站點(非語系，一個國家站點會有多個語系)。
* **核心資訊來源：**
  * **使用者 IP 地址：** 國家代碼：優先透過 CDN 邊緣運算平台（如 Vercel, Cloudflare）在 HTTP 請求頭中提供的地理位置資訊（x-vercel-ip-country）獲取。若此標頭不存在，則啟用備用方案，透過伺服器端的 IP 地理定位服務（如 MaxMind GeoLite2）將 IP 轉換為國家代碼。
  * **預先配置的「國家-子網域映射表」：** 一份預先配置的靜態設定，定義國家代碼與子網域的對應關係。例如：{ "TW": "tw", "US": "us", "JP": "jp" }。
  * **功能啟用開關：** 
    * enableGeoRedirect: (布林值) 是否啟用地理位置判斷功能。 
    * forceRedirect: (布林值) 在 enableGeoRedirect 為 true 的前提下，是否強制將使用者重定向到對應的國家站點。
* **判斷與處理邏輯：**
  * 啟用判斷： 首先檢查 enableGeoRedirect(地理位置) 是否為 true。若為 false，則完全跳過此步驟的後續邏輯。
  * 獲取國家代碼：
    * 獲取使用者的國家代碼 DetectedCountry（例如 "TW"）。
    * 若無法獲取國家代碼（API失敗或無資料），則 DetectedCountry 設為 null，跳過重定向邏輯**
    * 查詢映射表，找到 DetectedCountry 對應的目標子網域 TargetSubdomain（例如 "tw"）。
    * 從當前請求的網址中，解析出當前的子網域 CurrentSubdomain（例如 "us"）。
  * 重定向決策
    * 如果 forceRedirect(重定向) 為 true 且 CurrentSubdomain(使用者的國家代碼) 與 TargetSubdomain(子網域) 不符，伺服器將執行 302 臨時重定向，將使用者導向到正確的子網域，並保持原有的路徑和查詢參數。例如，從 https://us.example.com/path 重定向到 https://tw.example.com/path。
    * 在其他所有情況下（forceRedirect(重定向) 為 false，或使用者已在正確的子網域），不執行任何重定向。DetectedCountry(國家代碼) 資訊將被傳遞到後續步驟使用。

### 2. 語系資料獲取 API
* **目的：** 此 API 的功能是提供網站所有可用的語系清單~~，以及一個基於使用者情境的推薦預設語系~~。它是一個能力提供者，在需要時被呼叫。
* **執行條件：** 僅在「多語系網站」模式下 (enableMultiLanguage 為 true) 才可能被呼叫。
* API： /api/ssr/languages?project=minmax2025&language=[預設語系]
  * project: 專案代碼 (例如 "minmax2025")
  * language: 一個預設語系，用於 API 回傳時的參考。
      
* 回傳資料：
    * availableLanguages: 可用語系清單 (例如 [{code: "zh-TW", name: "繁體中文"}, ...])
    * defaultLanguage: API 推薦的預設語系
    * version: 語系列表的版本號，用於快取控制


### 3. Cookie 檢查與語系設定
* **目的 ：** 管理語系相關的 Cookie，並在必要時觸發 API 呼叫以獲取最新的語系資料，實現高效能快取。
* **執行條件：** 僅在「多語系網站」模式下 (enableMultiLanguage 為 true) 執行。
* **Cookie 類型：**
  * **語系資料快取Cookie (languageData)：**
    * 儲存API回傳的語系清單和版本號
    * 用於快取控制，避免重複API呼叫
    * 格式：`{availableLanguages: [...], defaultLanguage: "zh-TW", version: "1.0"}`

  * **使用者偏好語系Cookie (userPreferredLanguage)：**
    * 僅在使用者「主動切換」語系時設定
    * 優先級高於API推薦語系
    * 用於無語系前綴URL的導引決策
* 步驟：
  1. **讀取現有Cookie：**
    * 讀取 languageData Cookie(語系資料快取)
    * 讀取 userPreferredLanguage Cookie(使用者偏好語系)

  2. **語系資料快取檢查：**
    * 檢查 languageData Cookie(語系資料快取) 是否存在
    * 檢查其內部儲存的 version 是否與當前系統設定的語系版本相符

  3. **API呼叫決策：**
    * 如果 languageData Cookie(語系資料快取) 不存在或版本已過期，則執行步驟 2 中定義的「語系資料獲取 API」呼叫
    * 將從 API 獲取到的最新語系資料（包含新的版本號）寫入 languageData Cookie(語系資料快取)

  4. **偏好語系準備：**
    * userPreferredLanguage Cookie(使用者偏好語系) 將在後續步驟中用於語系導引決策
    * 此Cookie僅在前端使用者主動切換語系時才會被設定或更新

### 4. 語系導引決策 (僅多語系網站)
* **目的：** 當使用者訪問無語系前綴的URL時，自動導引到適當的語系URL。
* **執行條件：**
  * enableMultiLanguage(多語系網站) 為 true
  * 當前URL路徑沒有語系前綴 (例如訪問 http://xxx.com 而非 http://xxx.com/en)
* **導引邏輯：**
  1. 確定目標語系 (優先順序)：
     1. 使用者偏好語系 Cookie (userPreferredLanguage) 
     2. 瀏覽器語言偏好 (Accept-Language header)
     3. 地理位置推薦語系 (基於步驟 1 的 DetectedCountry)
     4. cookie中的預設語系
     5. 若以上皆無，則使用一個全域的預設語系。
  2. 執行302重定向到帶語系前綴的URL
     * 例如：http://xxx.com → http://xxx.com/en


### 5. 最終語系確定與路徑處理
* **目的 ：** 確定當前頁面最終要渲染的語系 (FinalLanguage) 和要傳遞給內容 API 的乾淨路徑 (CleanURI)。
* **處理邏輯 ：**
  * **單語系網站**
    * FinalLanguage 直接使用靜態配置的唯一語系。
    * CleanURI 為原始請求路徑
  * **多語系網站**
    * 確定 FinalLanguage (優先順序如下)：
      1. 從 URL 路徑前綴解析出的語系 (例如 /zh-TW/... → zh-TW)。
      2. 若無，則用使用者偏好語系 Cookie (userPreferredLanguage)

    * 確定 CleanURI:
      * 如果 URL 路徑中匹配到了語系前綴，則移除該前綴部分，得到乾淨路徑。
      * 如果沒有匹配到，則保持原始路徑不變。


### 6. 呼叫內容 API 與錯誤處理
* **目的 ：** 使用前序步驟準備好的參數，獲取頁面所需的主要內容。
* **處理邏輯 ：**
  1. 組裝 API 請求:
     * language = FinalLanguage (來自步驟 4)
     * uri = CleanURI (來自步驟 4)
  2. 呼叫內容 API: GET /api/ssr/page/detail?project=...&language=[語系]&uri=[路徑]
  3. 回傳處理:
     * 若 API 成功回傳資料 → 進入渲染流程。
     * 若 API 回傳無資料或發生錯誤 → 伺服器應回傳 { notFound: true }，觸發前端框架顯示 404 頁面。

### 7. 前端 UI 建議與資訊傳遞
* **目的 ：** 在伺服器完成渲染後，前端介面根據後端傳遞的元數據，向使用者顯示友善的切換建議。
* **後端需傳遞的元數據**
  伺服器在渲染頁面時，必須將以下資訊注入到前端 JavaScript 環境中：
  * detectedCountry: 偵測到的使用者國家代碼 (來自步驟 1)。 
  * currentCountrySubdomain: 當前子網域 (來自步驟 1)。 
  * finalLanguage: 當前頁面最終渲染的語系 (來自步驟 4)。 
  * preferredLanguage: 使用者的偏好語系，主要來自 Accept-Language Header。
* **前端顯示邏輯**
  * 國家切換建議:
    * 邏輯: 比較 detectedCountry(使用者國家代碼) 對應的子網域與 currentCountrySubdomain。如果不一致，則根據網站類型顯示相應提示：
      * **多站點架構**: 顯示「建議您前往 XX 站點」的提示
      * **單站點架構**: 顯示「偵測到您位於 XX 國家，是否要切換」
    * 用途範例:
      * 電商網站: 切換到對應國家的商品、價格、配送選項
  * 語系切換建議:
    * 條件: 多語系網站。
    * 邏輯: 
      * 比較 finalLanguage(最終渲染的語系) 與 preferredLanguage(使用者的偏好語系)。如果不一致，且 preferredLanguage(使用者的偏好語系) 是網站支援的可用語系之一，則顯示「建議您切換到 XX 語系」的提示。
      * 當使用者主動切換語系時，前端需要：
        1. 設定 userPreferredLanguage Cookie(使用者偏好語系)
        2. 導引到新語系的對應頁面URL（如 /zh-tw/current-path）


## 情境說明
### 情境一：住在東京的 Kenji 第一次來訪

Kenji 是一位住在東京的上班族，他的電腦瀏覽器預設語言是日文。

1.  **輸入網址：** Kenji 在瀏覽器輸入 `http://xxx.com`。
2.  **地區偵測：** 系統立刻偵測到 Kenji 來自日本。由於我們設有專屬的日本子網站，系統便**直接將他轉向到 `http://jp.xxx.com`**，提供更符合日本市場的內容。
3.  **語言確認：** `jp.xxx.com` 網站的預設語言剛好也是日文，與 Kenji 的瀏覽器設定相符。
4.  **最終結果：** Kenji 無需任何操作，第一眼看到的就是完整的日文版網站。系統同時在他電腦中留下一個「偏好日文」的標記 (Cookie)。

---

### 情境二：在台灣工作的法國人 Amélie

Amélie 是一位在台灣工作的法國人，她的筆電瀏覽器一直都設定為法文。

1.  **輸入網址：** 她第一次聽說 `http://xxx.com` 並前往瀏覽。
2.  **地區偵測：** 系統偵測到她位於台灣，但我們沒有專門的台灣子網站，所以她仍然留在 `http://xxx.com`。
3.  **語言偵測：** 此時，系統檢查到她的瀏覽器語言是法文 (`fr`)。雖然網站的預設畫面是繁體中文，但系統發現我們有提供法文版。
4.  **最終結果：** 為了讓 Amélie 更方便，系統**自動將她導引至 `http://xxx.com/fr`**。她看到的直接就是親切的法文介面。系統也為她留下了「偏好法文」的標記。

---

### 情境三：Amélie 後來的改變與再次造訪

過了幾天，Amélie 為了練習中文，在網站上手動將語言從法文切換到了繁體中文 (`zh-tw`)。

1.  **手動切換：** 當她點擊切換語言後，網站立刻更新了她電腦中的標記，從「偏好法文」**改為「偏好繁體中文」**。
2.  **再次造訪：** 下週，Amélie 又想起了這個網站，再次在瀏覽器輸入 `http://xxx.com`。
3.  **讀取偏好：** 這次，系統會優先檢查她上次留下的標記，發現她偏好的是繁體中文。
4.  **最終結果：** 系統不再理會她瀏覽器的法文設定，而是**直接將她導向到 `http://xxx.com` 的繁體中文版**。因為，**您的手動選擇，永遠是第一順位**。

---